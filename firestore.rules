rules_version = '2';

// DIP (Deductible Impact Protection) Firebase Security Rules
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation and security
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Check both: hardcoded admin email OR database-driven admin check
      return isAuthenticated() && (
        request.auth.token.email == "admin@dipmembers.com" ||
        exists(/databases/$(database)/documents/admins/$(request.auth.token.email))
      );
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidVehicleData() {
      return request.resource.data.keys().hasAll(['make', 'model', 'year', 'isActive', 'lastUpdated', 'ownerId'])
        && request.resource.data.make is string && request.resource.data.make.size() > 0
        && request.resource.data.model is string && request.resource.data.model.size() > 0
        && request.resource.data.year is string && request.resource.data.year.size() == 4
        && request.resource.data.isActive is bool
        && request.resource.data.lastUpdated is timestamp
        && request.resource.data.ownerId is string;
    }
    
    // === USER PROFILE MANAGEMENT (with phone number support) ===
    match /users/{userId} {
      // Users can read their own profile (includes phone numbers)
      allow read: if isOwner(userId);
      
      // Allow ANY authenticated user to read (needed for Cloud Functions called by admin)
      // This allows admin to send notifications to users
      allow read: if isAuthenticated();
      
      // Users can create their profile during signup (phone number optional)
      allow create: if isOwner(userId);
      
      // Users can update their profile but cannot change critical system fields
      // Allow FCM token updates, profile picture, and personal info updates
      allow update: if isOwner(userId)
        && request.resource.data.email == resource.data.email
        && request.resource.data.isAdmin == resource.data.isAdmin
        && request.resource.data.isActive == resource.data.isActive;
      
      // Users can delete their own account
      allow delete: if isOwner(userId);
      
      // Admin can read all profiles for management dashboard
      allow read: if isAdmin();
      
      // Admin can update any user profile
      allow update: if isAdmin();
      
      // Admin can create user accounts manually
      allow create: if isAdmin();
      
      // Admin can delete user accounts
      allow delete: if isAdmin();
    }
    
    // === VEHICLE MANAGEMENT ===
    // Supports persistent vehicle subscription status (isActive field)
    // Users can update subscription status and it will persist across sessions
    match /vehicles/{vehicleId} {
      // Users can read vehicles they own (by ownerId or ownerEmail)
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.ownerId 
            || request.auth.token.email == resource.data.ownerEmail);
      
      // Users can create vehicles and set themselves as owner with required fields
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.ownerId
        && isValidVehicleData();
      
      // Users can update their own vehicles (including subscription status)
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.ownerId
        && request.auth.uid == request.resource.data.ownerId
        && request.resource.data.ownerId == resource.data.ownerId; // Prevent ownership transfer
      
      // Admin can read all vehicles for dashboard
      allow read: if isAdmin();
      
      // Providers can read vehicle information for assigned claims
      allow read: if isAuthenticated();
      
      // Admin can update any vehicle
      allow update: if isAdmin();
      
      // Allow owners to delete their own vehicles; admin can delete any
      // Allow delete if the authenticated user owns the vehicle by uid OR by email (legacy docs)
      allow delete: if (
        isAuthenticated() && (
          request.auth.uid == resource.data.ownerId ||
          request.auth.token.email == resource.data.ownerEmail
        )
      ) || isAdmin();
    }
    
    // === CLAIMS MANAGEMENT (with phone number support) ===
    match /claims/{claimId} {
      // Users can read/write their own claims (includes phone numbers for admin contact)
      allow read, write: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can create claims and set themselves as owner (phone number required)
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own claims
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Users can delete their own claims (for cancellation) - only pending/in-review
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId
        && (resource.data.status == "Pending" || resource.data.status == "In Review" || resource.data.status == "pending" || resource.data.status == "inReview");
      
      // Providers can read claims that are assigned to them (simplified for now)
      allow read: if isAuthenticated();
      
      // Admin can read/write/delete all claims for management (includes phone access)
      allow read, write, delete: if isAdmin();
    }
    
    // === REQUESTS MANAGEMENT (new collection for member requests) ===
    match /requests/{requestId} {
      // Users can read their own requests (includes phone numbers for admin contact)
      // Support both userId and userEmail matching for backward compatibility
      allow read: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId || 
            request.auth.token.email == resource.data.userEmail);
      
      // Users can create requests and set themselves as owner (phone number required)
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own requests
      allow update: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId || 
            request.auth.token.email == resource.data.userEmail);
      
      // Users can delete their own requests (for cancellation) - only pending/in-review
      allow delete: if isAuthenticated() 
        && (request.auth.uid == resource.data.userId || 
            request.auth.token.email == resource.data.userEmail)
        && (resource.data.status == "Pending" || resource.data.status == "In Review");
      
      // Admin can read/write/delete all requests for management (includes phone access)
      allow read, write, delete: if isAdmin();
    }
    
    // === ADMINS COLLECTION (controls who is admin - managed via Firebase Console only) ===
    match /admins/{email} {
      // Any authenticated user can check if they are admin (needed for app login)
      allow read: if isAuthenticated();
      // No client-side writes - manage admins only through Firebase Console
      allow write: if false;
    }
    
    // === ADMIN COLLECTIONS ===
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // === ADMIN EXPORTS (for CSV export emails) ===
    match /adminExports/{exportId} {
      // Only admin can create export requests
      allow create: if isAdmin();
      // Admin can read their own exports
      allow read: if isAdmin();
      // Cloud Functions can update (status) - no client updates needed
      allow update: if false;
      // Admin can delete old exports
      allow delete: if isAdmin();
    }
    
    // === ACCOUNT DELETIONS (for admin notification when users delete accounts) ===
    match /accountDeletions/{deletionId} {
      // Any authenticated user can create a deletion record (when deleting their own account)
      allow create: if isAuthenticated();
      // Only admin can read deletion records
      allow read: if isAdmin();
      // No client updates - Cloud Functions handle status updates
      allow update: if false;
      // Admin can delete old records
      allow delete: if isAdmin();
    }
    
    // === ADMIN EVENTS (Tow Calls, Emergency, Attorney Referrals) ===
    // Members can create event documents; admins can read/manage
    match /admin_events/{eventId} {
      // Allow any authenticated user to create event documents
      allow create: if isAuthenticated() &&
        request.resource.data.event in ["tow_call", "emergency", "attorney_referral"] &&
        request.resource.data.timestamp is timestamp;
      
      // Admins can read/list and manage these events
      allow read, update, delete: if isAdmin();
    }
    
    // === CONSENT LOGS ===
    match /consent_logs/{logId} {
      allow create: if isAuthenticated();
      // Allow users to read their own logs
      allow read: if isAuthenticated() && request.auth.uid == resource.data.user_id;
      // Admin can read all logs
      allow read: if isAdmin();
      // No updates/deletes by clients
      allow update, delete: if false;
    }
    
    match /analytics/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // === NOTIFICATIONS ===
    // Admin can create notifications for any user
    // Users can read, update, and delete their own notifications
    // Any authenticated user can create notifications (for admin notifications from members)
    match /notifications/{notificationId} {
      // Users can read notifications addressed to them
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Users can update their own notifications (to mark as read)
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId; // Can't change owner
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Admin can read all notifications
      allow read: if isAdmin();
      
      // Any authenticated user can create notifications (allows members to notify admin)
      allow create: if isAuthenticated();
      
      // Admin can update any notification
      allow update: if isAdmin();
      
      // Admin can delete any notification
      allow delete: if isAdmin();
    }
    
    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /support/{ticketId} {
      allow read, write: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.userId;
      allow read, write: if isAdmin();
    }
    
    // === PROVIDER MANAGEMENT ===
    match /providers/{providerId} {
      // Allow anyone to create provider applications (no auth required for signup)
      allow create: if true;
      
      // Allow public read for credential verification during signup completion
      allow read: if true;
      
      // Only admins can update provider status
      allow update: if isAdmin();
      
      // Only admins can delete provider applications
      allow delete: if isAdmin();
    }
    
    // === PROVIDER PROFILES ===
    match /provider_profiles/{profileId} {
      // Providers can read their own profile
      allow read: if isAuthenticated() && request.auth.uid == profileId;
      
      // Providers can update their own profile
      allow update: if isAuthenticated() && request.auth.uid == profileId;
      
      // Admins can read/write all provider profiles
      allow read, write: if isAdmin();
    }
    
    // === APPLICANTS ===
    match /applicants/{applicantId} {
      // Providers can read applicants assigned to them
      allow read: if isAuthenticated() && request.auth.uid == resource.data.providerId;
      
      // Providers can update applicant status
      allow update: if isAuthenticated() && request.auth.uid == resource.data.providerId;
      
      // Admins can read/write all applicants
      allow read, write: if isAdmin();
    }
    
    // === ASSIGNMENTS ===
    match /assignments/{assignmentId} {
      // Allow authenticated users to read assignments (temporary for testing)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update assignments (temporary for testing)
      allow update: if isAuthenticated();
      
      // Admins can read/write/create all assignments
      allow read, write, create: if isAdmin();
    }
    
    // === MARKETPLACE LISTINGS ===
    match /marketplace/{listingId} {
      // Anyone can read marketplace listings (including guests)
      allow read: if true;
      
      // Users can create listings and set themselves as seller
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.sellerId;
      
      // Users can update their own listings
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.sellerId
        && request.auth.uid == request.resource.data.sellerId; // Can't transfer ownership
      
      // Users can delete their own listings
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.sellerId;
      
      // Admin can manage all listings
      allow read, write, delete: if isAdmin();
    }
    
    // === MARKETPLACE LISTINGS (alternate collection name) ===
    match /marketplace_listings/{listingId} {
      // Anyone can read marketplace listings (including guests)
      allow read: if true;
      
      // Users can create listings and set themselves as seller
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.sellerId;
      
      // Users can update their own listings
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.sellerId;
      
      // Users can delete their own listings
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.sellerId;
      
      // Admin can manage all listings
      allow read, write, delete: if isAdmin();
    }
    
    // === MARKETPLACE CONVERSATIONS ===
    match /marketplace_conversations/{conversationId} {
      // Any authenticated user can read/write conversations they're involved in
      // Using simpler rules - participants check done in app logic
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // === MARKETPLACE MESSAGES ===
    match /marketplace_messages/{messageId} {
      // Users can read messages from conversations they're part of
      // Note: This requires querying the conversation first in the app
      allow read: if isAuthenticated();
      
      // Users can create messages where they are the sender
      allow create: if isAuthenticated() 
        && request.auth.uid == request.resource.data.senderId;
      
      // Users can update messages they sent (mark as read, etc.)
      allow update: if isAuthenticated();
      
      // Admin can manage all messages
      allow read, write, delete: if isAdmin();
    }
    
    // Block all other database access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
